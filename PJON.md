# PJON

[TOC]

---
[PJON官网](https://www.pjon.org/)
[github](https://github.com/gioblu/PJON)

---

## 简介
PJON(Padded Jittering Operative Network)是一个Arduino兼容，多主(multi-master)，多种媒体(multi-media)的通信总线系统。它提出了一个标准，被设计成一个框架，并实现了一个完全软件模拟的网络协议栈。
PJON的local模式支持254个设备连接，在shared模式下可以支持4,294,697,395个总线(1,090,921,692,930个设备)连接。由于它模块化、动态的数据包格式、低内存占用和低开销（5-22字节）的特性，PJON可作为1-Wire或i2c的替代方案用于连接资源有限的MCU（微控制单元），也可用于代替TCP- IP，与更复杂的网络相连。

概念模型图：
```
PJON的目标是通过使用一组新的开源协议，在各种媒体上实现不同系统的互操作性
_____________________________________________
| 7 应用层                         			|
| Remote access, automation, data sharing     |
|_____________________________________________|
| 6 持久层                                     |
| Encryption, encoding, data compression      |
|_____________________________________________|
| 5 会话层                                     |
| Semi-permanent interactive exchange         |
|_____________________________________________|
 You are here
 _|___________________________________________
| 4 运输层: PJON                               |
| Error detection, traffic control,           |
| network service identification,             |
| asynchronous acknowledgement                |
|_____________________________________________|
| 3 网络层: PJON                               |
| Addressing, packet transmission,            |
| packet identification, routing, switching,  |
| synchronous acknowledgment                  |
|_____________________________________________|
| 2 数据链路层: PJDL, PJDLR, PJDLS, TSDL        |
| Collision avoidance, frame transmission,    |
| synchronous response                        |
|_____________________________________________|
| 1 物理层                                     |
| Electric, radio, light impulses             |
|_____________________________________________|
```

---
## 基本概念

- 只有在通讯介质未使用时才会发生传输
- 数据包的传输是由一个字节的头部控制的
- 设备间通讯的数据包最大长度为255（默认），或65535字节（在数据包头部分添加ext length标识，并使用CRC32检验）
- 每个设备设备都有相同的发送和接受权限（每个设备既能发又能收）
- 每个设备都有一个唯一的1字节的id号-->device id
- 每个总线（即包含若干设备的组）都有一个唯一的4字节的id --> bus id
- 每个设备可以被连接到n个PJON总线上
- 在同一介质（电，光，无线电等）上多个总线可以共存
- 可以请求同步确认或异步确认
- 网络服务标识符使用2字节的端口识别（？）

### 总线
一个PJON总线由一组设备（最多254个）组成，这些设备在同一介质上进行发送和接收。设备间依靠数据包进行通信，通信时遵从公平性和每个设备的权限来平等地分享可用带宽。

```
 _______     _______     _______     _______
|       |   |       |   |       |   |       |
| ID 1  |   | ID 2  |   | ID 3  |   | ID 4  |
|_______|   |_______|   |_______|   |_______|
____|___________|___________|___________|___
      ___|___     ___|___     ___|___
     |       |   |       |   |       |
     | ID 5  |   | ID 6  |   | ID 7  |
     |_______|   |_______|   |_______|
```
### 总线网络
一个PJON总线网络是n个PJON总线共享一个（不是一种）介质或依靠路由器相互连接时组成的网络。
在一个共享的介质上，需要使用一个4字节的bus id 来将一组设备与相连的其他总线的通讯隔离，使得许多设备能够在同一通讯介质上共存和广播（联网？原词为network）。

```
一个碰撞域

    BUS ID 0.0.0.1             BUS ID 0.0.0.2
 _______     _______         _______     _______
|       |   |       |       |       |   |       |
| ID 1  |   | ID 2  |       | ID 1  |   | ID 2  |
|_______|   |_______|       |_______|   |_______|
______|___________|______________|___________|______
       ___|___                     ___|___
      |       |                   |       |
      | ID 3  |                   | ID 3  |
      |_______|                   |_______|
```
总线网络可以由在数据链路层使用不同协议或不同介质的多个总线组成，通过交换机或路由器连接。
```
2 collision domains

DATA-LINK PJDL                   DATA-LINK PJDLS
BUS ID 0.0.0.1                   BUS ID 0.0.0.2
 _______     _______              _______     _______
|       |   |       |            |       |   |       |
| ID 1  |   | ID 2  |            | ID 1  |   | ID 2  |
|_______|   |_______|   ______   |_______|   |_______|
_____|___________|_____|ROUTER|______|___________|____
       ___|___         | ID 3 |         ___|___
      |       |        |______|        |       |
      | ID 3  |                        | ID 3  |
      |_______|                        |_______|
```
### 交换机
PJON里的交换机是一种解决使用不同物理层或者数据链路层的直连总线间透明传输问题的设备。 它可以依赖于默认网关作为较大树型网络中的叶子节点进行操作.（？）

```
 ______             ________             ______
|      | PJDL bus  |        | PJDLR bus |      |
| ID 1 |___________| SWITCH |___________| ID 2 |
|______|           |________|           |______|
```

### 路由器
PJON的路由器将使用不同**专有**传输介质的N个PJON设备或总线连接起来，它可以将一个设备（总线或传输介质）发出的数据包传输到另一个设备（总线或传输介质）

```
2 个碰撞域

           BUS ID 0.0.0.1                   BUS ID 0.0.0.2
         _______     _______              _______     _______
        |       |   |       |            |       |   |       |
        | ID 1  |   | ID 2  |            | ID 1  |   | ID 2  |
        |_______|   |_______|   ______   |_______|   |_______|
electric_____|___________|_____|ROUTER|______|___________|____ radio
           ___|___             | ID 3 |          ___|___
          |       |            |______|         |       |
          | ID 3  |                             | ID 3  |
          |_______|                             |_______|
```

## PJON报文首部定义
以下是PJON元数据首部的每一位（bit）与值的映射关系

```
HEADER BITMAP
    1      2     3    4    5     6     7     8
 ______ ______ ____ _____ _____ _____ _____ _____
|PACKET|EXT.  |CRC |PORT |ACK  | ACK |TX   |MODE |
|ID    |LENGTH|    |     |MODE |     |INFO |     |
|______|______|____|_____|_____|_____|_____|_____|
```
1. `PACKET ID` 位表示是否包含2字节的包id（0无1有）
2. `EXT. LENGTH `位表示包的长度是否有附加的长度（0表示无附加，1表示有附加长度）
3. `CRC`  位表示使用哪种CRC校验方法（0表示CRC8，1表示CRC32）
4. `PORT` 位表示是否包含2字节的网络服务标识符（0表示无，1表示有）
5. `ACK MODE`位表示使用哪种确认方式（0表示同步确认，1表示异步确认）
6. `ACK`位表示是否需要确认（0表示不需要，1表示需要）
7. `TX INFO`位表示是否包含发送方的消息，如包含bus id和device id(0表示不包含，1表示包含)
8. `MODE`位表示数据包是以local模式还是shared模式格式化(0表示local，1表示shared)
    标准传输过程中不合规范的数据包头部设置：
- `----1-0-`或`ACK MODE`位为1，`TX INFO`位为0（异步确认需要知道谁是发送者）
- `----1---`或`EXT.LENGTH`位为1且`CRC`位为0（强制CRC32长度>15）

发送广播中不合规范的数据包头设置：

- `-----1--`或`ACK`位为1（广播时不支持确认）

- `----1---`或`ACK MODE`为1（广播时不支持确认）

`-`符号代表该位的值不影响

## 循环冗余校验

PJON同时支持CRC8和CRC32，以确保在各种情况和数据包长度上的安全性

详细内容见原文文档

## 包传输

默认本地数据包传输是两个设备之间的可选双向通信，可以分为3个不同阶段：**信道分析**，**传输**和可选**响应**。在信道分析阶段，发送器在开始传输之前评估介质的状态以避免冲突。如果介质是免费使用的，则传输阶段从数据包完全传输的地方开始。接收设备计算CRC并在正确数据接收的情况下开始发送单个字节PJON_ACK（十进制6）的响应阶段。如果没有收到确认，则在指数退避延迟之后，发送器设备重试，直到接收到确认或达到最大尝试次数并丢弃分组传输。